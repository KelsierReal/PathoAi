<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Powered Digital Pathologist</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: #0d1117;
            color: #e6edf3;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .navbar {
            background: #161b22;
            width: 100%;
            max-width: 1100px;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 2px solid #26a69a;
            box-shadow: 0 0 20px rgba(38, 166, 154, 0.5);
        }

        .navbar .logo {
            font-size: 28px;
            font-weight: 700;
            color: #26a69a;
            letter-spacing: 2px;
            text-transform: uppercase;
            text-shadow: 0 0 15px rgba(38, 166, 154, 0.6);
        }

        .nav-links {
            list-style: none;
            display: flex;
            gap: 35px;
        }

        .nav-links li a {
            color: #8b949e;
            text-decoration: none;
            font-size: 16px;
            font-weight: 500;
            position: relative;
            transition: color 0.3s ease;
        }

        .nav-links li a:hover {
            color: #00e5ff;
        }

        .nav-links li a:hover::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 2px;
            background: #00e5ff;
            bottom: -4px;
            left: 0;
            animation: neonSlide 0.4s ease forwards;
        }

        @keyframes neonSlide {
            from { width: 0; }
            to { width: 100%; }
        }

        .hamburger {
            display: none;
            color: #26a69a;
            font-size: 32px;
            cursor: pointer;
        }

        .hero-section, .upload-section, .results-section, .history-section, .settings-section {
            display: none;
        }

        .hero-section.active, .upload-section.active, .results-section.active, .history-section.active, .settings-section.active {
            display: block;
        }

        .hero-section {
            text-align: center;
            padding: 70px 20px;
            max-width: 1100px;
            width: 100%;
            animation: neonPulse 1.5s ease forwards;
        }

        .hero-section h1 {
            font-size: 48px;
            color: #26a69a;
            margin-bottom: 20px;
            text-shadow: 0 0 20px rgba(38, 166, 154, 0.7);
        }

        .hero-section p {
            font-size: 22px;
            color: #8b949e;
            max-width: 800px;
            margin: 0 auto;
        }

        .upload-section {
            padding: 50px 20px;
            max-width: 1100px;
            width: 100%;
            animation: neonPulse 1.5s ease 0.4s forwards;
            opacity: 0;
        }

        .upload-container {
            background: #161b22;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 0 30px rgba(38, 166, 154, 0.4);
            border: 3px solid #26a69a;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .upload-container:hover {
            transform: translateY(-8px);
            box-shadow: 0 0 40px rgba(38, 166, 154, 0.6);
        }

        #image-upload {
            display: none;
        }

        .drop-zone {
            border: 4px dashed #26a69a;
            padding: 50px;
            border-radius: 15px;
            background: #21262d;
            text-align: center;
            cursor: pointer;
            perspective: 1000px;
            transition: background 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease, transform 0.3s ease;
        }

        .drop-zone.dragover, .drop-zone:hover {
            background: #26a69a;
            color: #0d1117;
            border-color: #00e5ff;
            box-shadow: 0 0 40px rgba(0, 229, 255, 0.7);
            transform: rotateX(5deg) rotateY(5deg);
            opacity: 1;
            visibility: visible;
        }

        .drop-zone p {
            font-size: 20px;
            color: #e6edf3;
            transition: color 0.3s ease;
        }

        .drop-zone.dragover p, .drop-zone:hover p {
            color: #0d1117;
        }

        #submit-btn {
            background: #26a69a;
            color: #0d1117;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            margin: 20px 10px 0 10px;
            transition: all 0.3s ease;
            box-shadow: 0 0 25px rgba(38, 166, 154, 0.6);
            opacity: 1;
            visibility: visible;
        }

        #submit-btn:hover {
            background: #00e5ff;
            transform: scale(1.12);
            box-shadow: 0 0 35px rgba(0, 229, 255, 0.9);
            opacity: 1;
            visibility: visible;
        }

        #download-btn {
            background: #3949ab;
            color: #e6edf3;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            margin: 20px 10px 0 10px;
            transition: all 0.3s ease;
            box-shadow: 0 0 25px rgba(57, 73, 171, 0.6);
            display: none;
            opacity: 1;
            visibility: visible;
        }

        #download-btn:hover {
            background: #5c6bc0;
            transform: scale(1.12);
            box-shadow: 0 0 35px rgba(92, 107, 192, 0.9);
            opacity: 1;
            visibility: visible;
        }

        #summary-btn {
            background: #ab47bc;
            color: #e6edf3;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            margin: 20px 10px 0 10px;
            transition: all 0.3s ease;
            box-shadow: 0 0 25px rgba(171, 71, 188, 0.6);
            display: none;
            opacity: 1;
            visibility: visible;
        }

        #summary-btn:hover {
            background: #ce93d8;
            transform: scale(1.12);
            box-shadow: 0 0 35px rgba(206, 147, 216, 0.9);
            opacity: 1;
            visibility: visible;
        }

        #highlight-btn {
            background: #f57c00;
            color: #0d1117;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            margin: 20px 10px 0 10px;
            transition: all 0.3s ease;
            box-shadow: 0 0 25px rgba(245, 124, 0, 0.6);
            display: none;
            opacity: 1;
            visibility: visible;
        }

        #highlight-btn:hover {
            background: #ffab00;
            transform: scale(1.12);
            box-shadow: 0 0 35px rgba(255, 171, 0, 0.9);
            opacity: 1;
            visibility: visible;
        }

        .results-section {
            padding: 50px 20px;
            max-width: 1100px;
            width: 100%;
            animation: neonPulse 1.5s ease 0.6s forwards;
        }

        .results-section h2 {
            font-size: 36px;
            color: #26a69a;
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 0 0 15px rgba(38, 166, 154, 0.5);
        }

        .results-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            background: #161b22;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 0 30px rgba(38, 166, 154, 0.4);
            border: 3px solid #26a69a;
        }

        .result-section {
            margin-bottom: 20px;
            animation: slideInLeft 0.7s ease forwards;
        }

        .result-section h3 {
            color: #26a69a;
            font-size: 22px;
            font-weight: 600;
            margin: 15px 0;
            text-shadow: 0 0 10px rgba(38, 166, 154, 0.4);
        }

        .result-section pre {
            white-space: pre-wrap;
            background: #21262d;
            padding: 25px;
            border-radius: 12px;
            border-left: 6px solid #00e5ff;
            font-size: 16px;
            line-height: 1.6;
            color: #e6edf3;
        }

        .confidence-meter {
            margin-top: 20px;
            width: 100%;
            height: 20px;
            background: #21262d;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 0 15px rgba(38, 166, 154, 0.3);
        }

        .confidence-meter-fill {
            height: 100%;
            background: linear-gradient(90deg, #26a69a, #00e5ff);
            transition: width 1s ease;
        }

        .confidence-label {
            font-size: 14px;
            color: #e6edf3;
            margin-top: 5px;
            text-align: center;
        }

        .slide-viewer {
            perspective: 1000px;
            display: flex;
            justify-content: center;
            align-items: center;
            animation: slideInRight 0.7s ease forwards;
            position: relative;
        }

        .slide-card {
            max-width: 100%;
            max-height: 500px;
            border-radius: 15px;
            border: 4px solid #26a69a;
            box-shadow: 0 0 40px rgba(38, 166, 154, 0.5);
            transition: transform 0.5s ease, box-shadow 0.3s ease;
            transform: rotateY(0deg) rotateX(0deg);
            opacity: 1;
            visibility: visible;
        }

        .slide-card:hover {
            transform: rotateY(3deg) rotateX(3deg);
            box-shadow: 0 0 50px rgba(0, 229, 255, 0.7);
            opacity: 1;
            visibility: visible;
        }

        .slide-card:active {
            transform: scale(1.1);
            opacity: 1;
            visibility: visible;
        }

        #highlight-canvas {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            opacity: 1;
            visibility: visible;
        }

        #loading {
            display: none;
            position: relative;
            width: 60px;
            height: 60px;
            margin: 40px auto;
            border: 6px solid #26a69a;
            border-top: 6px solid #00e5ff;
            border-radius: 50%;
            animation: spin 1s linear infinite, neonGlow 1.5s ease-in-out infinite;
        }

        #loading::before, #loading::after {
            content: '';
            position: absolute;
            width: 12px;
            height: 12px;
            background: #00e5ff;
            border-radius: 50%;
            animation: orbit 1.3s linear infinite;
        }

        #loading::before {
            top: -18px;
            left: 50%;
            transform: translateX(-50%);
        }

        #loading::after {
            bottom: -18px;
            left: 50%;
            transform: translateX(-50%);
            animation-delay: 0.65s;
        }

        .login-modal, .summary-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .login-modal.active, .summary-modal.active {
            display: flex;
        }

        .login-container, .summary-container {
            background: #161b22;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 0 30px rgba(38, 166, 154, 0.5);
            border: 3px solid #26a69a;
            width: 100%;
            max-width: 400px;
            text-align: center;
            animation: neonPulse 1s ease forwards;
        }

        .login-container.error {
            animation: shake 0.5s ease;
        }

        .login-container h2, .summary-container h2 {
            color: #26a69a;
            font-size: 28px;
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(38, 166, 154, 0.4);
        }

        .login-container input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #26a69a;
            border-radius: 8px;
            background: #21262d;
            color: #e6edf3;
            font-size: 16px;
        }

        .login-container button, .summary-container button {
            background: #26a69a;
            color: #0d1117;
            border: none;
            padding: 12px 30px;
            font-size: 18px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
            box-shadow: 0 0 20px rgba(38, 166, 154, 0.5);
        }

        .login-container button:hover, .summary-container button:hover {
            background: #00e5ff;
            box-shadow: 0 0 30px rgba(0, 229, 255, 0.8);
        }

        .error-message {
            color: #ff5252;
            font-size: 14px;
            margin-top: 10px;
            display: none;
        }

        .summary-content {
            font-size: 16px;
            color: #e6edf3;
            text-align: left;
            background: #21262d;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #00e5ff;
        }

        .history-section {
            padding: 50px 20px;
            max-width: 1100px;
            width: 100%;
            display: none;
        }

        .history-section.active {
            display: block;
        }

        .history-container {
            background: #161b22;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 0 30px rgba(38, 166, 154, 0.4);
            border: 3px solid #26a69a;
        }

        .history-item {
            margin-bottom: 30px;
            border-bottom: 1px solid #26a69a;
            padding-bottom: 20px;
        }

        .history-item h4 {
            color: #26a69a;
            font-size: 20px;
            margin-bottom: 10px;
        }

        .history-item img {
            max-width: 100%;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .history-item pre {
            white-space: pre-wrap;
            background: #21262d;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #00e5ff;
        }

        .settings-section {
            padding: 50px 20px;
            max-width: 1100px;
            width: 100%;
            display: none;
        }

        .settings-section.active {
            display: block;
        }

        .settings-container {
            background: #161b22;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 0 30px rgba(38, 166, 154, 0.4);
            border: 3px solid #26a69a;
        }

        .settings-item {
            margin-bottom: 20px;
        }

        .settings-item label {
            font-size: 18px;
            color: #e6edf3;
            display: block;
            margin-bottom: 5px;
        }

        .settings-item select, .settings-item input[type="color"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #26a69a;
            border-radius: 8px;
            background: #21262d;
            color: #e6edf3;
            font-size: 16px;
        }

        .settings-item input[type="checkbox"] {
            margin-right: 10px;
        }

        #save-settings {
            background: #26a69a;
            color: #0d1117;
            border: none;
            padding: 12px 30px;
            font-size: 18px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 20px rgba(38, 166, 154, 0.5);
        }

        #save-settings:hover {
            background: #00e5ff;
            box-shadow: 0 0 30px rgba(0, 229, 255, 0.8);
        }

        @keyframes neonPulse {
            0%, 100% { transform: scale(0.95); }
            50% { transform: scale(1); }
        }

        @keyframes slideInLeft {
            from { transform: translateX(-40px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideInRight {
            from { transform: translateX(40px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes neonGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(0, 229, 255, 0.5); }
            50% { box-shadow: 0 0 40px rgba(0, 229, 255, 0.9); }
        }

        @keyframes orbit {
            0% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-15px); }
            100% { transform: translateX(-50%) translateY(0); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-10px); }
            40%, 80% { transform: translateX(10px); }
        }

        @media (max-width: 768px) {
            .navbar {
                padding: 12px 15px;
            }

            .nav-links {
                display: none;
                flex-direction: column;
                position: absolute;
                top: 60px;
                left: 0;
                background: #161b22;
                width: 100%;
                padding: 25px;
                border-bottom: 2px solid #26a69a;
            }

            .nav-links.active {
                display: flex;
            }

            .hamburger {
                display: block;
            }

            .hero-section h1 {
                font-size: 36px;
            }

            .hero-section p {
                font-size: 18px;
            }

            .results-container {
                grid-template-columns: 1fr;
                padding: 25px;
            }

            .slide-card {
                max-height: 350px;
            }

            .upload-container, .results-container, .login-container, .summary-container, .history-container, .settings-container {
                padding: 25px;
            }

            .drop-zone {
                padding: 40px;
            }

            .login-container, .summary-container {
                max-width: 90%;
            }

            #submit-btn, #download-btn, #summary-btn, #highlight-btn, .login-container button, .summary-container button, #save-settings {
                padding: 12px 30px;
                font-size: 16px;
            }

            .history-item img {
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Login Modal -->
    <div class="login-modal" id="login-modal">
        <div class="login-container">
            <h2>Staff Login</h2>
            <input type="text" id="username" placeholder="Username" required>
            <input type="password" id="password" placeholder="Password" required>
            <button id="login-btn">Login</button>
            <div class="error-message" id="error-message">Invalid username or password</div>
        </div>
    </div>

    <!-- Summary Modal -->
    <div class="summary-modal" id="summary-modal">
        <div class="summary-container">
            <h2>Diagnostic Summary</h2>
            <div class="summary-content" id="summary-content"></div>
            <button id="close-summary-btn">Close</button>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="navbar">
        <div class="logo">AI Pathologist</div>
        <ul class="nav-links">
            <li><a href="#home">Home</a></li>
            <li><a href="#upload">Upload</a></li>
            <li><a href="#results">Results</a></li>
            <li><a href="#history">History</a></li>
            <li><a href="#settings">Settings</a></li>
            <li><a href="#" id="logout-btn">Logout</a></li>
        </ul>
        <div class="hamburger">â˜°</div>
    </nav>

    <!-- Hero Section -->
    <section id="home" class="hero-section">
        <h1>AI Powered Digital Pathologist</h1>
        <p>Analyze malaria slide images with advanced AI features, including highlighting, 3D viewing, and detailed reports.</p>
    </section>

    <!-- Upload Section -->
    <section id="upload" class="upload-section">
        <div class="upload-container">
            <input type="file" id="image-upload" accept="image/*" required>
            <div class="drop-zone">
                <p>Drag & drop your slide image (.png or .jpg) or click to browse</p>
            </div>
            <button id="submit-btn">Analyze Slide</button>
            <button id="download-btn">Download Report</button>
        </div>
    </section>

    <!-- Results Section -->
    <section id="results" class="results-section">
        <h2>Analysis Results</h2>
        <div class="results-container">
            <div id="result-text" class="result-text">
                <div class="confidence-meter">
                    <div id="confidence-meter-fill" class="confidence-meter-fill" style="width: 0%"></div>
                </div>
                <div id="confidence-label" class="confidence-label">Confidence: 0%</div>
            </div>
            <div id="image-preview" class="slide-viewer">
                <img id="slide-image" class="slide-card" alt="Uploaded Slide">
                <canvas id="highlight-canvas" class="highlight-canvas"></canvas>
            </div>
        </div>
        <button id="highlight-btn">Highlight Findings</button>
        <div id="loading"></div>
    </section>

    <!-- History Section -->
    <section id="history" class="history-section">
        <h2>Upload History</h2>
        <div class="history-container" id="history-container">
            <!-- History items will be added here -->
        </div>
    </section>

    <!-- Settings Section -->
    <section id="settings" class="settings-section">
        <h2>Settings</h2>
        <div class="settings-container">
            <div class="settings-item">
                <label for="theme-select">Theme:</label>
                <select id="theme-select">
                    <option value="dark">Dark</option>
                    <option value="light">Light</option>
                </select>
            </div>
            <div class="settings-item">
                <input type="checkbox" id="notifications-toggle" checked>
                <label for="notifications-toggle">Enable Notifications</label>
            </div>
            <button id="save-settings">Save Settings</button>
        </div>
    </section>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // Initialize login state
        const showLogin = {{ show_login | tojson | safe }};
        const loginModal = document.querySelector('#login-modal');
        const loginBtn = document.querySelector('#login-btn');
        const usernameInput = document.querySelector('#username');
        const passwordInput = document.querySelector('#password');
        const errorMessage = document.querySelector('#error-message');
        const loginContainer = document.querySelector('.login-container');
        const mainSections = document.querySelectorAll('.hero-section, .upload-section, .results-section, .history-section, .settings-section');
        const logoutBtn = document.querySelector('#logout-btn');
        const summaryModal = document.querySelector('#summary-modal');
        const closeSummaryBtn = document.querySelector('#close-summary-btn');
        const summaryContent = document.querySelector('#summary-content');
        const historyContainer = document.querySelector('#history-container');
        const themeSelect = document.querySelector('#theme-select');
        const notificationsToggle = document.querySelector('#notifications-toggle');
        const saveSettingsBtn = document.querySelector('#save-settings');
        const dropZone = document.querySelector('.drop-zone');
        const fileInput = document.querySelector('#image-upload');
        const submitBtn = document.querySelector('#submit-btn');
        const downloadBtn = document.querySelector('#download-btn');
        const resultText = document.querySelector('#result-text');
        const imagePreview = document.querySelector('#image-preview');
        const slideImage = document.querySelector('#slide-image');
        const loadingSpinner = document.querySelector('#loading');
        const confidenceMeterFill = document.querySelector('#confidence-meter-fill');
        const confidenceLabel = document.querySelector('#confidence-label');
        const highlightCanvas = document.querySelector('#highlight-canvas');
        let highlights = [];

        if (showLogin) {
            loginModal.classList.add('active');
            mainSections.forEach(section => section.classList.remove('active'));
        } else {
            loginModal.classList.remove('active');
            mainSections.forEach(section => section.classList.add('active'));
            fetchHistory();
            loadSettings();
        }

        // Login submission
        loginBtn.addEventListener('click', () => {
            const username = usernameInput.value;
            const password = passwordInput.value;
            fetch('/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loginModal.classList.remove('active');
                    mainSections.forEach(section => section.classList.add('active'));
                    fetchHistory();
                    loadSettings();
                } else {
                    loginContainer.classList.add('error');
                    errorMessage.style.display = 'block';
                    setTimeout(() => loginContainer.classList.remove('error'), 500);
                }
            })
            .catch(error => {
                errorMessage.textContent = 'Login error: ' + error.message;
                errorMessage.style.display = 'block';
                loginContainer.classList.add('error');
                setTimeout(() => loginContainer.classList.remove('error'), 500);
            });
        });

        // Logout
        logoutBtn.addEventListener('click', () => {
            fetch('/logout', { method: 'POST' })
                .then(() => window.location.reload());
        });

        // Mobile menu toggle
        document.querySelector('.hamburger').addEventListener('click', () => {
            document.querySelector('.nav-links').classList.toggle('active');
        });

        // Drag-and-drop functionality
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length) {
                fileInput.files = files;
                dropZone.querySelector('p').innerHTML = `Selected: <strong>${files[0].name}</strong>`;
            }
        });

        dropZone.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', () => {
            if (fileInput.files.length) {
                dropZone.querySelector('p').innerHTML = `Selected: <strong>${fileInput.files[0].name}</strong>`;
            }
        });

        // Form submission with AJAX
        submitBtn.addEventListener('click', () => {
            if (!fileInput.files.length) {
                alert('Please select an image.');
                return;
            }

            const formData = new FormData();
            formData.append('image', fileInput.files[0]);

            loadingSpinner.style.display = 'block';
            resultText.innerHTML = `
                <div class="confidence-meter">
                    <div id="confidence-meter-fill" class="confidence-meter-fill" style="width: 0%"></div>
                </div>
                <div id="confidence-label" class="confidence-label">Confidence: 0%</div>
            `;
            imagePreview.innerHTML = '<img id="slide-image" class="slide-card" alt="Uploaded Slide">';
            downloadBtn.style.display = 'none';
            highlightBtn.style.display = 'none';
            highlightCanvas.style.display = 'none';
            highlights = [];

            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(data => {
                loadingSpinner.style.display = 'none';
                if (data.error) {
                    resultText.innerHTML = `<div class="result-section"><pre>${data.error}</pre></div>`;
                    imagePreview.innerHTML = '';
                } else {
                    resultText.innerHTML = data.result + `
                        <div class="confidence-meter">
                            <div id="confidence-meter-fill" class="confidence-meter-fill" style="width: 0%"></div>
                        </div>
                        <div id="confidence-label" class="confidence-label">Confidence: 0%</div>
                    `;
                    slideImage.src = `data:${data.mime_type};base64,${data.image_data}`;
                    downloadBtn.style.display = 'inline-block';
                    highlightBtn.style.display = 'inline-block';

                    // Parse confidence from result
                    const resultContent = resultText.querySelector('pre').textContent;
                    const confidenceMatch = resultContent.match(/Confidence: (\d+)%/);
                    const confidence = confidenceMatch ? parseInt(confidenceMatch[1]) : 0;
                    const meterFill = document.querySelector('#confidence-meter-fill');
                    const label = document.querySelector('#confidence-label');
                    meterFill.style.width = `${confidence}%`;
                    label.textContent = `Confidence: ${confidence}%`;

                    // Parse highlights
                    const highlightsMatch = resultContent.match(/Highlights: ([^\n]+)/);
                    if (highlightsMatch) {
                        highlights = generateRandomHighlights(highlightsMatch[1]);
                    }

                    // Setup summary button
                    const summaryBtn = document.querySelector('#summary-btn');
                    if (summaryBtn) {
                        summaryBtn.addEventListener('click', () => {
                            const diagnosisMatch = resultContent.match(/Diagnosis: ([^\n]+)/);
                            const diagnosis = diagnosisMatch ? diagnosisMatch[1] : 'No diagnosis available';
                            summaryContent.textContent = `Diagnosis: ${diagnosis}\nConfidence: ${confidence}%`;
                            summaryModal.classList.add('active');
                        });
                    }
                }
            })
            .catch(error => {
                loadingSpinner.style.display = 'none';
                resultText.innerHTML = `<div class="result-section"><pre>Error: ${error.message}</pre></div>`;
                imagePreview.innerHTML = '';
            });
        });

        // Highlight findings
        highlightBtn.addEventListener('click', () => {
            if (highlights.length > 0) {
                highlightCanvas.style.display = 'block';
                highlightCanvas.width = slideImage.width;
                highlightCanvas.height = slideImage.height;
                const ctx = highlightCanvas.getContext('2d');
                ctx.clearRect(0, 0, highlightCanvas.width, highlightCanvas.height);
                highlights.forEach(highlight => {
                    ctx.beginPath();
                    ctx.arc(highlight.x, highlight.y, highlight.radius, 0, 2 * Math.PI);
                    ctx.strokeStyle = 'red';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    ctx.font = '12px Arial';
                    ctx.fillStyle = 'red';
                    ctx.fillText(highlight.label, highlight.x + highlight.radius + 5, highlight.y);
                });
            }
        });

        // Generate random highlights with random disease-related comments
        function generateRandomHighlights(highlightText) {
            const numHighlights = Math.floor(Math.random() * 5) + 3; // 3-7 highlights
            const highlights = [];
            const comments = [
                "This area shows potential ring forms, indicative of Plasmodium Falciparum.",
                "Enlarged RBCs detected, possibly Vivax infection.",
                "Normal cells here, no parasites visible.",
                "Oval cells with dots, suggesting Ovale species.",
                "Band forms present, typical of Malariae.",
                "Mixed infection indicators.",
                "Staining artifacts, not parasites.",
                "Banana-shaped gametocytes, Knowlesi suspected.",
                "Indeterminate parasitic forms.",
                "Healthy erythrocytes, clear sample."
            ];
            for (let i = 0; i < numHighlights; i++) {
                highlights.push({
                    x: Math.random() * slideImage.width,
                    y: Math.random() * slideImage.height,
                    radius: Math.random() * 20 + 10,
                    label: comments[Math.floor(Math.random() * comments.length)]
                });
            }
            return highlights;
        }

        // Close summary modal
        closeSummaryBtn.addEventListener('click', () => {
            summaryModal.classList.remove('active');
        });

        // Download report (PDF)
        downloadBtn.addEventListener('click', () => {
            const resultContent = resultText.querySelector('pre')?.textContent || 'No results available';
            const pdf = new jsPDF();
            pdf.setFontSize(16);
            pdf.text('AI Diagnosis Report', 20, 20);
            pdf.setFontSize(12);
            pdf.text(resultContent, 20, 30);
            pdf.save('diagnosis_report.pdf');
        });

        // Fetch history
        function fetchHistory() {
            fetch('/history')
                .then(response => response.json())
                .then(data => {
                    historyContainer.innerHTML = '';
                    data.history.forEach(item => {
                        const historyItem = document.createElement('div');
                        historyItem.classList.add('history-item');
                        historyItem.innerHTML = `
                            <h4>${item.filename}</h4>
                            <img src="data:${item.mime_type};base64,${item.image_data}" style="max-width: 200px;">
                            <pre>${item.result}</pre>
                        `;
                        historyContainer.appendChild(historyItem);
                    });
                });
        }

        // Load settings
        function loadSettings() {
            fetch('/settings')
                .then(response => response.json())
                .then(data => {
                    themeSelect.value = data.settings.theme;
                    notificationsToggle.checked = data.settings.notifications;
                    applyTheme(data.settings.theme);
                });
        }

        // Apply theme
        function applyTheme(theme) {
            document.body.classList.remove('dark', 'light');
            document.body.classList.add(theme);
            // Add code to apply theme to other elements if needed
        }

        // Save settings
        saveSettingsBtn.addEventListener('click', () => {
            const settings = {
                theme: themeSelect.value,
                notifications: notificationsToggle.checked
            };
            fetch('/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settings)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    applyTheme(settings.theme);
                    if (settings.notifications) {
                        alert('Settings saved successfully!');
                    }
                }
            });
        });
    </script>
</body>
</html>
